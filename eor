#!/usr/bin/env bash
LIGHTBLUE='\033[1;34m'
BACK='\033[0m'
SPLASH="""
                        ,,.                                  .
                 ,/*..*(@@#/****,,,,..............,,...,,*((##
             .**(k#(#@@@@@@@@@88kk############################
          ,*,/k8@@@@@@@@88kkk###(((###########################
           *#8@@@@@@@@@@######################################
           ./k8@@@@@@@@@8k####################################
          ./#k@@@@@@@@@@@8k###################################
          *(k88kk8@@@@@@@@8k##################################
         ,#k##kkk888@@@@88k###################################
        ,(####kk8#k8@k8k##################################
      ./######k8kkk###8k8k##################################
     ,/#######kkk#(/(#kk888kk#################################
    *(###kk#####kk*,(##kk#(#####k#############################
   ,(##k##k###(,.,,*(###(**(#kk#kkk###########################
  *(#####kk####(((###((#kkk#(###kkk###########################
 .(k##((##((###kk######(kk##(#kkkkkk######################k###
 *(##(((##/(######(((//***/***//(#kk##########################
./#(((((#(/(###((/***,,****//*****/#k#########################
./##(((###/((/*******,,****/(/****/#k(/(###(################k#
 *((((((##****,,,,,**/*****/(/**///#k(**/#####################
 ,/#((((#(*****//**********/(/,***/#k/*,*/(###################
 ,(#(((((*..****/*******,**/*****/##(/****/###################
  ,(##(#(,     .,***//***//****(###(*****,/#k###############(*
   ,(#((*         .,***/###########(/*****/(###############(/.
    *(#/.             .,,,.,(kk###(/*******/###############(. 
     ..                     .*(###(*******.,###############/. 
                         .,,/##((/*****/*. ./############((*. 
                        (#####(/****,**,   *#####((((##(/*,.  
                        */(//*********,  ,*#kk####((((/***.   
                          ,*/****/*,   ,/###(((####(/***,.    
                                      ,(#####(///***/*.       
                                       .,**,,,,,*/*..         
"""
printf "${LIGHTBLUE}"
printf "${SPLASH}"
printf "${BACK}"

RED='\033[0;31m'
NC='\033[0m' # No Color
printf "I ${RED}love${NC} Stack Overflow\n"

: "${WATCH_OPTS:=""}"

echo "Running make..."
make "$@" >/tmp/eor-$$-before.txt 2>&1
echo "Output of make:"

cat /tmp/eor-$$-before.txt
read -p "Continue? " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    cp /tmp/eor-$$-before.txt /tmp/eor-$$-after.txt
    
    (sleep 1 && find -L . | entr sh -c "make $* > /tmp/eor-$$-after.txt 2>&1") &
    # shellcheck disable=SC2068
    watch ${WATCH_OPTS[@]} --color "diff /tmp/eor-$$-before.txt /tmp/eor-$$-after.txt --unified | colordiff"
    kill -TERM %1
fi
